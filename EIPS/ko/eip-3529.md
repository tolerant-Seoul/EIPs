---
eip: 3529
title: 환불 감소
description: SELFDESTRUCT 가스 환불을 제거하고 SSTORE 가스 환불을 현재 환불 메커니즘의 "악용"이 더 이상 불가능한 수준으로 감소시킵니다.
author: Vitalik Buterin (@vbuterin), Martin Swende (@holiman)
discussions-to: https://ethereum-magicians.org/t/eip-3529-reduction-in-refunds-alternative-to-eip-3298-and-3403-that-better-preserves-existing-clearing-incentives/6097
status: Final
type: Standards Track
category: Core
created: 2021-04-22
requires: 2200, 2929, 2930
lang: ko
original: ../eip-3529.md
---

## 간단한 요약

`SELFDESTRUCT`에 대한 가스 환불을 제거하고, `SSTORE`에 대한 가스 환불을 환불이 여전히 상당하지만 현재 환불 메커니즘의 "악용"이 더 이상 가능하지 않을 정도로 낮은 수준으로 감소시킵니다.

## 동기

`SSTORE` 및 `SELFDESTRUCT`에 대한 가스 환불은 원래 애플리케이션 개발자가 더 이상 필요하지 않은 스토리지 슬롯과 컨트랙트를 정리하는 "좋은 상태 위생"을 실천하는 애플리케이션을 작성하도록 동기를 부여하기 위해 도입되었습니다. 그러나 이 기술의 이점은 예상보다 훨씬 낮은 것으로 입증되었으며, 가스 환불은 여러 예상치 못한 해로운 결과를 가져왔습니다:

* 환불은 GasToken을 발생시킵니다. GasToken은 저렴한 수수료 기간에서 고가 수수료 기간으로 가스 공간을 이동하는 이점이 있지만, 특히 상태 크기를 악화시키고(상태 슬롯이 가스를 절약하기 위한 "배터리"로 효과적으로 사용됨) 블록체인 가스 사용량을 비효율적으로 막히게 하는 네트워크에 대한 단점도 있습니다.
* 환불은 블록 크기 변동을 증가시킵니다. 블록에서 소비될 수 있는 실제 가스의 이론적 최대량은 문서상 가스 한도의 거의 두 배입니다(환불은 블록의 후속 트랜잭션에 가스 공간을 추가하지만, 환불은 트랜잭션에서 사용된 가스의 50%로 제한됨). 이는 치명적이지 않지만, 특히 환불이 EIP-1559가 할 수 있는 것보다 훨씬 더 오랫동안 2배 사용량 급증을 유지하는 데 사용될 수 있다는 점을 감안하면 여전히 바람직하지 않습니다.

## 사양

### 매개변수

| 상수 | 값 |
| - | - |
| `FORK_BLOCK` | TBD |
| `MAX_REFUND_QUOTIENT` | 5 |

`block.number >= FORK_BLOCK`인 블록에 대해 다음 변경 사항이 적용됩니다.

1. `SELFDESTRUCT` 환불을 제거합니다.
2. `SSTORE_CLEARS_SCHEDULE`([EIP-2200](./eip-2200.md)에 정의됨)을 `SSTORE_RESET_GAS + ACCESS_LIST_STORAGE_KEY_COST`([EIP-2929](./eip-2929.md) + [EIP-2930](./eip-2930.md) 기준 4,800 가스)로 교체합니다.
3. 트랜잭션 후 환불되는 최대 가스를 `gas_used // MAX_REFUND_QUOTIENT`로 감소시킵니다.

참고: 이전에 _환불되는 최대 가스_는 `gas_used // 2`로 정의되었습니다. 여기서 상수 `2`를 `MAX_REFUND_QUOTIENT`로 명명하고 값을 `5`로 변경합니다.

## 근거

[EIP-2200](./eip-2200.md#specification)에서 환불에 대해 세 가지 경우가 도입되었습니다:

1. 원래 값이 0이 아니고 새 값이 0이면 환불 카운터에 `SSTORE_CLEARS_SCHEDULE`(현재 15,000) 가스를 추가합니다.
2. 원래 값이 0이고 현재 값이 0이 아니며 새 값이 0이면 환불 카운터에 `SSTORE_SET_GAS - SLOAD_GAS`(현재 19,900) 가스를 추가합니다.
3. 원래 값이 0이 아니고 현재 값이 다른 0이 아닌 값이며 새 값이 원래 값과 같으면 환불 카운터에 `SSTORE_RESET_GAS - SLOAD_GAS`(현재 4,900) 가스를 추가합니다.

이 중 (1)만 가스토큰을 가능하게 하고 블록이 블록 가스 한도보다 더 많은 가스를 실행에 소비할 수 있게 합니다. (2)는 이 속성을 가지지 않는데, 19,900 환불을 얻으려면 _동일한 스토리지 슬롯_이 이전에 0에서 0이 아닌 값으로 변경되었어야 하고 20,000 가스가 소비되었기 때문입니다. 한 스토리지 슬롯을 정리하여 가스를 얻고 다른 스토리지 슬롯을 편집하는 데 사용할 수 없다는 점은 가스 토큰에 사용할 수 없음을 의미합니다. 또한 환불을 얻으려면 스토리지 쓰기 및 확장 효과를 _되돌려야_ 하므로 환불된 가스는 블록 처리에서 클라이언트의 부하에 기여하지 않습니다. (3)도 유사하게 동작합니다: 4,900 환불은 동일한 스토리지 슬롯에서 5,000 가스가 이전에 소비된 경우에만 얻을 수 있습니다.

이 EIP는 경우 (1)을 다룹니다. 가스토큰이 불가능한 조건(즉, 스토리지 슬롯에 넣은 것보다 더 많은 가스를 얻을 수 없음)을 유사한 "페어링" 인수를 사용하여 설정할 수 있습니다. 동일한 트랜잭션 내 동일한 스토리지 슬롯에서 각 환불을 이전 지출에 매핑합니다. 스토리지 슬롯이 원래 값이 0이 아닐 때 0으로 변경되면 두 가지 가능성이 있습니다:

1. 스토리지 슬롯이 처음으로 0으로 설정되는 경우일 수 있습니다. 이 경우 이 이벤트를 처음으로 스토리지 슬롯을 읽고 편집하는 `SSTORE_RESET_GAS + ACCESS_LIST_STORAGE_KEY_COST` 최소 비용과 페어링할 수 있습니다.
2. 스토리지 슬롯이 두 번째 이후로 0으로 설정되는 경우일 수 있습니다. 이 경우 이 이벤트를 값이 0에서 _멀어진_ 가장 최근의 이전 시간과 페어링할 수 있으며, 이때 `SSTORE_CLEARS_SCHEDULE` 가스가 환불에서 _제거_됩니다.

두 번째 이후 이벤트의 경우 `SSTORE_CLEARS_SCHEDULE`이 어떤 값을 가지든 상관없습니다. 해당 크기의 모든 환불이 동일한 크기의 환불 _제거_와 페어링되기 때문입니다. 이것은 첫 번째 이벤트를 남깁니다. 슬롯에 소비된 총 가스가 양수임을 보장하려면 `SSTORE_CLEARS_SCHEDULE <= SSTORE_RESET_GAS + ACCESS_LIST_STORAGE_KEY_COST`가 필요합니다. 따라서 이 EIP는 단순히 `SSTORE_CLEARS_SCHEDULE`을 이 두 비용의 합으로 줄입니다.

이 EIP에 대한 하나의 대안적 직관은 아직 읽지 않은 데이터(종종 "쓸모없는" 데이터)를 정리하는 것에 대한 순 환불이 없지만, 읽은 데이터("유용한" 데이터일 가능성이 높음)를 정리하는 것에 대한 순 환불은 계속 있을 것이라는 것입니다.

## 하위 호환성

환불은 현재 트랜잭션 실행 _후_에만 적용되므로 실행 중 특정 호출 프레임에서 사용 가능한 가스 양에 영향을 미칠 수 없습니다. 따라서 환불을 제거해도 코드 실행 능력이 중단되지 않지만, 일부 애플리케이션을 경제적으로 불가능하게 만들 것입니다.

가스 토큰은 가치가 없어집니다. 오늘날 기존 가스 토큰 체계나 온체인 비용을 줄이기 위한 커스텀 대안을 자주 사용하는 DeFi 차익 거래 봇은 이러한 더 이상 작동하지 않는 가스 저장 메커니즘에 대한 호출을 제거하기 위해 코드를 다시 작성하면 이점을 얻을 것입니다.

그러나 `new = original = 0 != current` 경우에 환불을 완전히 보존하고 다른 `nonzero -> zero` 경우에 _일부_ 환불을 유지하면 유리한 가스 비용 처리를 받는(받을 자격이 있는) 몇 가지 주요 사용 사례가 계속 그렇게 되도록 보장합니다. 예를 들어 `zero -> nonzero -> zero` 스토리지 설정 패턴은 계속 ~100 가스만 소비합니다. 이러한 패턴의 두 가지 중요한 예는 다음과 같습니다:

* 재진입 방지 잠금(일반적으로 자식 호출이 시작되기 직전에 0에서 1로 전환되고, 자식 호출이 끝나면 다시 0으로 전환됨)
* ERC20 승인 후 전송("승인된 값"은 토큰 전송이 승인될 때 0에서 0이 아닌 값으로 변경되고, 토큰 전송이 처리될 때 다시 0으로 변경됨)

### 스토리지 정리 인센티브에 대한 영향

이전 환불 제거 EIP([EIP-3298](./eip-3298.md) 및 [EIP-3403](./eip-3403.md))에 대한 비판은 이러한 EIP가 값을 0으로 설정하는 인센티브를 완전히 제거하여, 사용자가 해당 스토리지 슬롯을 다시 사용할 가능성이 가장 작더라도 스토리지 슬롯을 완전히 정리하지 않도록 장려한다는 것입니다.

예를 들어 ERC20 토큰 1단위가 있고 전체 잔액을 주거나 판매하는 경우, 대신 0.999999단위만 주고 나머지는 남겨둘 수 있습니다. 향후 동일한 계정으로 해당 토큰을 다시 획득하기로 결정하면 `SSTORE`에 22100(제로에서 논제로 설정에 20000) 대신 5000 가스(읽기에 2100 + 논제로에서 논제로 설정에 2900)만 지불하면 됩니다. 오늘날 이것은 정리에 대한 15000 환불로 상쇄되므로, 슬롯을 다시 사용할 것이라고 `15000 / 17100 = 87.7%` 이상 확신하는 경우에만 이렇게 할 인센티브가 있습니다. EIP-3298 또는 EIP-3403을 사용하면 상쇄 인센티브가 존재하지 않으므로, 슬롯을 다시 사용할 확률이 0%보다 _조금이라도_ 높으면 논제로로 설정하는 것이 더 낫습니다.

4800 가스의 환불이 남아 있으므로, 해당 슬롯을 다시 사용할 확률이 `4800 / 17100 = 28.1%` 이상인 경우에만 스토리지 슬롯을 논제로로 유지할 인센티브가 있습니다. 이것은 완벽하지 않지만, 전체 잔액을 정리하면 동일한 주소로 토큰을 나중에 다시 획득할 평균적인 기대보다 높을 가능성이 높습니다.

환불을 소비된 가스의 1/5로 제한하면 이 환불이 블록 처리에 필요한 스토리지 쓰기 작업 양을 최대 25%만 증가시킬 수 있어, 이 메커니즘을 스토리지 쓰기 중심 서비스 거부 공격에 사용하는 능력을 제한합니다.

## 테스트 케이스

### EIP-2929 가스 비용

참고로 '핫' 슬롯과 '콜드' 슬롯 사이에는 차이가 있습니다. 이 표는 모든 접근된 스토리지 슬롯이 이미 '핫'이라고 가정한 [EIP-2929](./eip-2929.md) 기준 값을 보여줍니다(차이는 일회성 비용 `2100` 가스임).

| 코드 | 사용된 가스 | 환불 | 원래값 | 1차 | 2차 | 3차 | 유효 가스 (환불 후)
| -- | -- | -- | -- | -- | -- | -- | -- |
| `0x60006000556000600055` | 212 | 0| 0 | 0 |  0 |  |  212 |
| `0x60006000556001600055` | 20112 | 0| 0 | 0 |  1 |  |  20112 |
| `0x60016000556000600055` | 20112 | 19900| 0 | 1 |  0 |  |  212 |
| `0x60016000556002600055` | 20112 | 0| 0 | 1 |  2 |  |  20112 |
| `0x60016000556001600055` | 20112 | 0| 0 | 1 |  1 |  |  20112 |
| `0x60006000556000600055` | 3012 | 15000| 1 | 0 |  0 |  |  -11988 |
| `0x60006000556001600055` | 3012 | 2800| 1 | 0 |  1 |  |  212 |
| `0x60006000556002600055` | 3012 | 0| 1 | 0 |  2 |  |  3012 |
| `0x60026000556000600055` | 3012 | 15000| 1 | 2 |  0 |  |  -11988 |
| `0x60026000556003600055` | 3012 | 0| 1 | 2 |  3 |  |  3012 |
| `0x60026000556001600055` | 3012 | 2800| 1 | 2 |  1 |  |  212 |
| `0x60026000556002600055` | 3012 | 0| 1 | 2 |  2 |  |  3012 |
| `0x60016000556000600055` | 3012 | 15000| 1 | 1 |  0 |  |  -11988 |
| `0x60016000556002600055` | 3012 | 0| 1 | 1 |  2 |  |  3012 |
| `0x60016000556001600055` | 212 | 0| 1 | 1 |  1 |  |  212 |
| `0x600160005560006000556001600055` | 40118 | 19900| 0 | 1 |  0 |  1 |  20218 |
| `0x600060005560016000556000600055` | 5918 | 17800| 1 | 0 |  1 |  0 |  -11882 |

### 감소된 환불 적용 시

환불이 `SSTORE_CLEARS_SCHEDULE`을 15000에서 4800으로 변경하여 부분적으로 제거되는 경우(그리고 selfdestruct 환불 제거) 이것이 비교 표입니다.

| 코드 | 사용된 가스 | 환불 | 원래값 | 1차 | 2차 | 3차 | 유효 가스 (환불 후)
| -- | -- | -- | -- | -- | -- | -- | -- |
| `0x60006000556000600055` | 212 | 0| 0 | 0 |  0 |  |  212 |
| `0x60006000556001600055` | 20112 | 0| 0 | 0 |  1 |  |  20112 |
| `0x60016000556000600055` | 20112 | 19900| 0 | 1 |  0 |  |  212 |
| `0x60016000556002600055` | 20112 | 0| 0 | 1 |  2 |  |  20112 |
| `0x60016000556001600055` | 20112 | 0| 0 | 1 |  1 |  |  20112 |
| `0x60006000556000600055` | 3012 | 4800| 1 | 0 |  0 |  |  -1788 |
| `0x60006000556001600055` | 3012 | 2800| 1 | 0 |  1 |  |  212 |
| `0x60006000556002600055` | 3012 | 0| 1 | 0 |  2 |  |  3012 |
| `0x60026000556000600055` | 3012 | 4800| 1 | 2 |  0 |  |  -1788 |
| `0x60026000556003600055` | 3012 | 0| 1 | 2 |  3 |  |  3012 |
| `0x60026000556001600055` | 3012 | 2800| 1 | 2 |  1 |  |  212 |
| `0x60026000556002600055` | 3012 | 0| 1 | 2 |  2 |  |  3012 |
| `0x60016000556000600055` | 3012 | 4800| 1 | 1 |  0 |  |  -1788 |
| `0x60016000556002600055` | 3012 | 0| 1 | 1 |  2 |  |  3012 |
| `0x60016000556001600055` | 212 | 0| 1 | 1 |  1 |  |  212 |
| `0x600160005560006000556001600055` | 40118 | 19900| 0 | 1 |  0 |  1 |  20218 |
| `0x600060005560016000556000600055` | 5918 | 7600| 1 | 0 |  1 |  0 |  -1682 |

## 보안 고려사항

환불은 트랜잭션 실행에 보이지 않으므로 트랜잭션 실행 로직에 영향을 미치지 않아야 합니다.

나중에 0으로 재설정된 제로에서 논제로 `SSTORE`를 계산하지 않으면 블록에서 실행에 소비될 수 있는 최대 가스 양은 가스 한도로 제한됩니다. 그러한 `SSTORE`가 재설정되면 스토리지가 확장되지 않고 클라이언트가 실제로 머클 트리를 조정할 필요가 없기 때문에 계산하지 않아도 괜찮습니다. 가스 소비는 환불되지만, 해당 옵코드를 처리하기 위해 클라이언트가 일반적으로 필요로 하는 노력도 취소됩니다. **클라이언트는 `new_value = original_value`인 경우 스토리지 쓰기를 수행하지 않도록 해야 합니다. 이것은 이더리움 초기부터 신중한 최적화였지만 이제 더 중요해졌습니다.**

## 저작권
저작권 및 관련 권리는 [CC0](../LICENSE.md)를 통해 포기됩니다.
