---
eip: 6780
title: 동일 트랜잭션에서만 SELFDESTRUCT
description: SELFDESTRUCT는 모든 자금을 대상으로 복구하지만, 생성과 동일한 트랜잭션에서 호출된 경우를 제외하고 계정을 삭제하지 않습니다.
author: Guillaume Ballet, Vitalik Buterin, Dankrad Feist
status: Final
type: Standards Track
category: Core
created: 2023-03-25
requires: 2681, 2929, 3529
lang: ko
original: https://github.com/ethereum/EIPs/blob/master/EIPS/eip-6780.md
---

## 요약

이 EIP는 `SELFDESTRUCT` 옵코드의 기능을 변경합니다. 새로운 기능은 계정의 모든 이더를 대상으로 보내는 것만 수행하며, `SELFDESTRUCT`가 컨트랙트가 생성된 동일한 트랜잭션에서 호출된 경우에만 현재 동작이 유지됩니다.

## 동기

`SELFDESTRUCT` 옵코드는 계정 상태의 대규모 변경, 특히 모든 코드와 스토리지 제거를 요구합니다. 이는 Verkle 트리에서는 불가능할 것입니다: 각 계정이 루트 계정에 명확하게 연결되지 않는 여러 다른 계정 키에 저장될 것이기 때문입니다.

이 EIP는 이 변경을 구현합니다. 자금을 검색하기 위해 `SELFDESTRUCT`만 사용하는 애플리케이션은 여전히 작동합니다. 컨트랙트를 생성한 동일한 트랜잭션에서 `SELFDESTRUCT`만 사용하는 애플리케이션도 변경 없이 계속 작동합니다.

## 명세

`SELFDESTRUCT`의 동작은 다음과 같이 변경됩니다:

### 1. 다른 트랜잭션에서 호출된 경우

`SELFDESTRUCT`가 `SELFDESTRUCT`를 호출하는 컨트랙트가 생성된 것과 동일하지 않은 트랜잭션에서 실행될 때:

- 현재 실행 프레임이 중단됩니다.
- `SELFDESTRUCT`는 어떤 데이터도 삭제하지 않습니다 (스토리지 키, 코드 또는 계정 자체 포함).
- `SELFDESTRUCT`는 전체 계정 잔액을 대상으로 전송합니다.
- 대상이 `SELFDESTRUCT`를 호출하는 컨트랙트와 동일한 경우 잔액에 순 변화가 없습니다. 이전 명세와 달리, 이 경우 이더가 소각되지 않습니다.
- EIP-3529 이후 환불이 제공되지 않습니다.
- EIP-2929의 `SELFDESTRUCT` 관련 규칙은 변경되지 않습니다.

### 2. 동일 트랜잭션에서 호출된 경우

`SELFDESTRUCT`가 컨트랙트가 생성된 동일한 트랜잭션에서 실행될 때:

- `SELFDESTRUCT`는 이 EIP 이전과 동일하게 동작합니다:
  - 현재 실행 프레임이 중단됩니다.
  - `SELFDESTRUCT`는 이전에 지정된 대로 데이터를 삭제합니다.
  - `SELFDESTRUCT`는 전체 계정 잔액을 대상으로 전송합니다.
  - `SELFDESTRUCT`를 호출하는 컨트랙트의 계정 잔액이 `0`으로 설정됩니다.
- 대상이 `SELFDESTRUCT`를 호출하는 컨트랙트와 동일한 경우 이더가 소각됩니다.
- EIP-3529 이후 환불이 제공되지 않습니다.
- EIP-2929의 `SELFDESTRUCT` 관련 규칙은 변경되지 않습니다.

컨트랙트는 생성 트랜잭션의 시작 시점 또는 CREATE 시리즈 작업이 실행을 시작할 때 (CREATE, CREATE2 및 향후 컨트랙트를 배포하는 기타 작업) 생성된 것으로 간주됩니다. 컨트랙트의 새 주소에 잔액이 있어도 여전히 컨트랙트 생성으로 간주됩니다.

`SELFDESTRUCT` 옵코드는 EIP-6049에 지정된 대로 더 이상 사용되지 않습니다. 이 새로운 동작을 고려하더라도 새로 배포된 컨트랙트에서의 사용은 강력히 권장되지 않으며, EVM에 대한 향후 변경으로 옵코드의 기능이 더 축소될 수 있습니다.

## 근거

`SELFDESTRUCT` 옵코드를 제거하는 것이 과거에 고려되었으며, 현재 이를 사용할 강력한 이유가 없습니다. 이 EIP는 일부 일반적인 `SELFDESTRUCT` 사용을 작동하게 유지하면서, 컨트랙트 버전 관리에서 오는 EVM 구현에 대한 변경의 복잡성을 줄이는 동작을 구현합니다.

카운터팩추얼 계정과 같은 사용 사례를 위해 계정 생성과 컨트랙트 생성을 두 개의 별개의 이벤트로 처리해야 합니다. 컨트랙트 생성 시 `SELFDESTRUCT`가 계정을 삭제할 수 있도록 허용함으로써 컨트랙트 생성 전에 잔액 외에 온체인 상태가 없었던 카운터팩추얼 인스턴스화된 컨트랙트의 스텁이 남지 않습니다.

## 역호환성

이 EIP는 합의 규칙을 수정하므로 하드포크가 필요합니다.

`SELFDESTRUCT` 후 `CREATE2`를 사용하여 동일한 주소에 컨트랙트를 재배포하는 데 의존하는 컨트랙트는 생성된 컨트랙트가 동일한 트랜잭션 내에서 `SELFDESTRUCT`를 호출하지 않으면 더 이상 제대로 작동하지 않습니다.

이전에는 실행 컨트랙트를 수혜자로 하는 `SELFDESTRUCT`를 호출하여 이더를 소각할 수 있었습니다. 컨트랙트가 트랜잭션 이전에 존재했다면 이더가 소각되지 않습니다. 컨트랙트가 트랜잭션에서 새로 생성되었다면 이전과 같이 이더가 소각됩니다.

## 테스트 케이스

이 EIP에 대한 테스트 케이스는 실행 명세 테스트 스위트 [`eip6780_selfdestruct`](https://github.com/ethereum/execution-spec-tests/tree/1983444bbe1a471886ef7c0e82253ffe2a4053e1/tests/cancun/eip6780_selfdestruct)에서 찾을 수 있습니다.

## 보안 고려사항

다음의 `SELFDESTRUCT` 적용은 손상되며 이러한 방식으로 사용하는 애플리케이션은 더 이상 안전하지 않습니다:

1. **업그레이드 가능한 컨트랙트**: `CREATE2`를 사용하여 동일한 위치에 컨트랙트를 재배포하여 컨트랙트를 업그레이드 가능하게 만드는 경우. 이는 더 이상 지원되지 않으며 ERC-2535 또는 다른 유형의 프록시 컨트랙트를 대신 사용해야 합니다.

2. **이더 소각**: 동일한 트랜잭션에서 생성되지 않은 컨트랙트에서 컨트랙트를 수혜자로 하는 `SELFDESTRUCT`를 통해 이더를 소각하는 데 의존하는 경우.

## 저작권

저작권 및 관련 권리는 CC0를 통해 포기되었습니다.
